name: Verify Tag ðŸ·ï¸
description: Verify the input tag or fetch the latest tag, and checkout to that tag if requested.

inputs:
  tag:
    description: "Tag to verify (empty for fetching latest tag)"
    required: false
    default: ""
  checkout:
    description: "Whether to checkout to the verified or fetched tag (default: false)"
    required: false
    default: "false"

outputs:
  tag:
    description: The tag that was verified or fetched
    value: ${{ steps.set_tag.outputs.tag }}

runs:
  using: "composite"
  steps:
    - name: Checkout code with all tags
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Fetch all history for all branches and tags
        persist-credentials: false
    - name: Verify and set output tag
      id: set_tag
      shell: bash
      run: |
        specified_tag=${{ inputs.tag }}
        if [ -z "$specified_tag" ]; then
          echo "Input tag is empty. Fetching latest tag."
          specified_tag=$(git describe --tags $(git rev-list --tags --max-count=1))
          if [ -z "$specified_tag" ]; then
            echo "No latest tag available. Exiting workflow."
            exit 1
          fi
        else
          if ! git rev-parse -q --verify "refs/tags/$specified_tag" >/dev/null; then
            echo "Invalid tag '$specified_tag'. Exiting workflow."
            exit 1
          fi
        fi
        echo "tag=$specified_tag" >> $GITHUB_OUTPUT
    - name: Checkout to specified tag
      if: ${{ inputs.checkout == 'true' }}
      shell: bash
      run: |
        echo "Checking out to tag ${{ steps.set_tag.outputs.tag }}"
        git checkout ${{ steps.set_tag.outputs.tag }}
